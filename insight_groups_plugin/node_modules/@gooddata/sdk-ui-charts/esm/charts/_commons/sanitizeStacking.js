import { __assign } from "tslib";
// (C) 2007-2022 GoodData Corporation
import isEmpty from "lodash/isEmpty";
import { bucketItems, bucketsFind, isAttribute, isMeasure, measureDoesComputeRatio, } from "@gooddata/sdk-model";
import { BucketNames } from "@gooddata/sdk-ui";
function isItemsArray(obj) {
    return !isEmpty(obj) && (isMeasure(obj[0]) || isAttribute(obj));
}
export function sanitizeConfig(input, config) {
    if (input === void 0) { input = []; }
    if (config === void 0) { config = {}; }
    if (!input.length) {
        return config;
    }
    var items = isItemsArray(input) ? input : bucketItems(bucketsFind(input, BucketNames.MEASURES));
    if (items) {
        var isComputeRatio = isComputeRatioMeasure(items[0]);
        var stackMeasures = config.stackMeasures, stackMeasuresToPercent = config.stackMeasuresToPercent;
        return __assign(__assign({}, config), { stackMeasures: stackMeasures && !isComputeRatio, stackMeasuresToPercent: stackMeasuresToPercent && !isComputeRatio });
    }
    return config;
}
function isComputeRatioMeasure(bucketItem) {
    return isMeasure(bucketItem) && measureDoesComputeRatio(bucketItem);
}
export function getSanitizedStackingConfig(executionDef, chartConfig) {
    var updatedChartConfig = chartConfig;
    // In case enableChartSorting is set to true and sort was not specified,
    // we need to change its value, so visualization is able to take default sort
    if (executionDef.sortBy.length === 0 && chartConfig.enableChartSorting) {
        updatedChartConfig = __assign(__assign({}, updatedChartConfig), { enableChartSorting: false });
    }
    if (executionDef.measures.length === 1) {
        var stackMeasures = chartConfig.stackMeasures, stackMeasuresToPercent = chartConfig.stackMeasuresToPercent;
        var singleMeasure = executionDef.measures[0];
        var isComputeRatio = measureDoesComputeRatio(singleMeasure);
        return __assign(__assign({}, updatedChartConfig), { stackMeasures: stackMeasures && !isComputeRatio, stackMeasuresToPercent: stackMeasuresToPercent && !isComputeRatio });
    }
    return updatedChartConfig;
}
//# sourceMappingURL=sanitizeStacking.js.map