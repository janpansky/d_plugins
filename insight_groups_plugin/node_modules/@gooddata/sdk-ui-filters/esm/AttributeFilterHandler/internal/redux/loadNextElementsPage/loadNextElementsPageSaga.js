import { __assign, __generator } from "tslib";
import { put, call, takeLatest, select, cancelled } from "redux-saga/effects";
import { getAttributeFilterContext } from "../common/sagas";
import { selectElementsForm } from "../common/selectors";
import { elementsSaga } from "../elements/elementsSaga";
import { actions } from "../store/slice";
import { selectHasNextPage, selectLoadNextElementsPageOptions } from "./loadNextElementsPageSelectors";
/**
 * @internal
 */
export function loadNextElementsPageWorker() {
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0: return [4 /*yield*/, takeLatest([
                    actions.loadNextElementsPageRequest.match,
                    actions.loadNextElementsPageCancelRequest.match,
                    actions.loadInitialElementsPageRequest.match,
                ], loadNextElementsPageSaga)];
            case 1:
                _a.sent();
                return [2 /*return*/];
        }
    });
}
/**
 * @internal
 */
export function loadNextElementsPageSaga(action) {
    var context, correlation, hasNextPage, loadOptions, elementsForm, loadOptionsWithExcludePrimaryLabel, result, error_1;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0: return [4 /*yield*/, call(getAttributeFilterContext)];
            case 1:
                context = _a.sent();
                if (actions.loadNextElementsPageCancelRequest.match(action) ||
                    actions.loadInitialElementsPageRequest.match(action)) {
                    // Saga was triggered by cancel request - do nothing, just jump to finally statement
                    return [2 /*return*/];
                }
                correlation = action.payload.correlation;
                return [4 /*yield*/, select(selectHasNextPage)];
            case 2:
                hasNextPage = _a.sent();
                if (!hasNextPage) {
                    return [2 /*return*/];
                }
                _a.label = 3;
            case 3:
                _a.trys.push([3, 9, 11, 15]);
                return [4 /*yield*/, put(actions.loadNextElementsPageStart({ correlation: correlation }))];
            case 4:
                _a.sent();
                return [4 /*yield*/, select(selectLoadNextElementsPageOptions)];
            case 5:
                loadOptions = _a.sent();
                return [4 /*yield*/, select(selectElementsForm)];
            case 6:
                elementsForm = _a.sent();
                loadOptionsWithExcludePrimaryLabel = __assign(__assign({}, loadOptions), { excludePrimaryLabel: !context.backend.capabilities.supportsElementUris && elementsForm === "values" });
                return [4 /*yield*/, call(elementsSaga, loadOptionsWithExcludePrimaryLabel)];
            case 7:
                result = _a.sent();
                return [4 /*yield*/, put(actions.loadNextElementsPageSuccess(__assign(__assign({}, result), { correlation: correlation })))];
            case 8:
                _a.sent();
                return [3 /*break*/, 15];
            case 9:
                error_1 = _a.sent();
                return [4 /*yield*/, put(actions.loadNextElementsPageError({
                        error: error_1,
                        correlation: correlation,
                    }))];
            case 10:
                _a.sent();
                return [3 /*break*/, 15];
            case 11: return [4 /*yield*/, cancelled()];
            case 12:
                if (!_a.sent()) return [3 /*break*/, 14];
                return [4 /*yield*/, put(actions.loadNextElementsPageCancel({ correlation: correlation }))];
            case 13:
                _a.sent();
                _a.label = 14;
            case 14: return [7 /*endfinally*/];
            case 15: return [2 /*return*/];
        }
    });
}
//# sourceMappingURL=loadNextElementsPageSaga.js.map