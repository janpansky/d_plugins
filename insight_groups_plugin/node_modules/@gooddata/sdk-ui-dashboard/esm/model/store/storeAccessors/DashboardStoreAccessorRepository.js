// (C) 2022 GoodData Corporation
import { invariant } from "ts-invariant";
import { DashboardStoreAccessor } from "./DashboardStoreAccessor";
import { idRef, serializeObjRef } from "@gooddata/sdk-model";
/**
 * This singleton class serves the selector and the dispatcher properties for given dashboard.
 *
 * @remarks
 * The {@link Dashboard} component has an optional property {@link IDashboardProps#onStateChange} through which
 * you can handle setting of the values for {@link DashboardDispatch} and {@link DashboardSelectorEvaluator}.
 *
 *
 * In your component using {@link Dashboard} you can create an onStateChange callback for your dashboard using
 * {@link DashboardStoreAccessorRepository#getOnChangeHandlerForDashboard} and pass it to mentioned Dashboard
 * component property.
 *
 * @example
 * ```
 *  const dashboardStoreAccessors = DashboardStoreAccessorRepository.getInstance();
 *
 *
 *  // in the code where needed
 *  dashboardStoreAccessors.getAccessorsForDashboard(<DASHBOARD_ID>).getDispatch()(
 *      changeDateFilterSelection("relative", "GDC.time.month", "-3", "0"),
 *  );
 *
 *  // or with check if accessor is initialized already
 *  if (dashboardStoreAccessors.isAccessorInitializedForDashboard(DASHBOARD_ID)) {
 *          setSelectResult(
 *              dashboardStoreAccessors.getAccessorsForDashboard(DASHBOARD_ID).getSelector()(
 *                  selectEffectiveDateFilterOptions,
 *              ),
 *          );
 *      }
 *
 *  return (
 *      <Dashboard dashboard={"<dashboardId>"} onStateChange={dashboardStoreAccessors.getOnChangeHandlerForDashboard(DASHBOARD_REF)}/>
 *  )
 * ```
 *
 * To get latest properties, use static member function {@link DashboardStoreAccessor#getInstance}. If there is already an instance
 * created, it will return this instance and will return new instance of the {@link DashboardStoreAccessor} otherwise.
 *
 * @public
 */
var DashboardStoreAccessorRepository = /** @class */ (function () {
    function DashboardStoreAccessorRepository() {
    }
    DashboardStoreAccessorRepository.getSerializedDashboardRef = function (dashboard) {
        var dashboardRef = typeof dashboard === "string" ? idRef(dashboard) : dashboard;
        return serializeObjRef(dashboardRef);
    };
    /**
     * Gets the correct {@link DashboardStoreAccessor} for given dashboard from the accessors map.
     *
     * @param dashboard - an {@link @gooddata/sdk-model#ObjRef} of the dashboard, or its id as a string
     */
    DashboardStoreAccessorRepository.getAccessorsForDashboard = function (dashboard) {
        var serializedDashboardRef = DashboardStoreAccessorRepository.getSerializedDashboardRef(dashboard);
        var accessor = this.accessors.get(serializedDashboardRef);
        invariant(accessor, "No accessor available for dashboard " + dashboard);
        return accessor;
    };
    /**
     * Gets the correct {@link DashboardSelectorEvaluator} for given dashboard from the accessors map.
     *
     * @param dashboard - an {@link @gooddata/sdk-model#ObjRef} of the dashboard, or its id as a string
     */
    DashboardStoreAccessorRepository.getDashboardSelectForDashboard = function (dashboard) {
        var _a;
        var serializedDashboardRef = DashboardStoreAccessorRepository.getSerializedDashboardRef(dashboard);
        var selectorEvaluator = (_a = this.accessors.get(serializedDashboardRef)) === null || _a === void 0 ? void 0 : _a.getDashboardSelect();
        invariant(selectorEvaluator, "No selector available for dashboard " + dashboard);
        return selectorEvaluator;
    };
    /**
     * Gets the correct {@link DashboardDispatch} for given dashboard from the accessors map.
     *
     * @param dashboard - an {@link @gooddata/sdk-model#ObjRef} of the dashboard, or its id as a string
     */
    DashboardStoreAccessorRepository.getDashboardDispatchForDashboard = function (dashboard) {
        var _a;
        var serializedDashboardRef = DashboardStoreAccessorRepository.getSerializedDashboardRef(dashboard);
        var dashboardDispatch = (_a = this.accessors.get(serializedDashboardRef)) === null || _a === void 0 ? void 0 : _a.getDashboardDispatch();
        invariant(dashboardDispatch, "No selector available for dashboard " + dashboard);
        return dashboardDispatch;
    };
    /**
     * Creates a {@link Dashboard#onStateChange} callback for given dashboard.
     *
     * @param dashboard - an {@link @gooddata/sdk-model#ObjRef} of the dashboard, or its id as a string
     */
    DashboardStoreAccessorRepository.getOnChangeHandlerForDashboard = function (dashboard) {
        var serializedDashboardRef = DashboardStoreAccessorRepository.getSerializedDashboardRef(dashboard);
        return function (state, dispatch) {
            var dashboardSelect = function (select) { return select(state); };
            DashboardStoreAccessorRepository.setAccessorForDashboard(serializedDashboardRef, dashboardSelect, dispatch);
        };
    };
    DashboardStoreAccessorRepository.setAccessorForDashboard = function (serializedDashboardRef, selector, dispatch) {
        DashboardStoreAccessorRepository.accessors.set(serializedDashboardRef, new DashboardStoreAccessor(selector, dispatch));
    };
    /**
     * Removes dashboard accessors from {@link DashboardStoreAccessorRepository#accessors} for the given dashboard {@link @gooddata/sdk-model#ObjRef}.
     *
     * @param dashboard - an {@link @gooddata/sdk-model#ObjRef} of the dashboard, or its id as a string
     */
    DashboardStoreAccessorRepository.clearAccessorForDashboard = function (dashboard) {
        var serializedDashboardRef = DashboardStoreAccessorRepository.getSerializedDashboardRef(dashboard);
        DashboardStoreAccessorRepository.accessors.delete(serializedDashboardRef);
    };
    /**
     * Clears all accessors saved in accessors map.
     */
    DashboardStoreAccessorRepository.clearAllAccessors = function () {
        DashboardStoreAccessorRepository.accessors.clear();
    };
    /**
     * Checks if accessors is initialized for given dashboard {@link @gooddata/sdk-model#ObjRef}.
     *
     * @param dashboard -an {@link @gooddata/sdk-model#ObjRef} of the dashboard, or its id as a string
     */
    DashboardStoreAccessorRepository.isAccessorInitializedForDashboard = function (dashboard) {
        var serializedDashboardRef = this.getSerializedDashboardRef(dashboard);
        var accessor = DashboardStoreAccessorRepository.accessors.get(serializedDashboardRef);
        return !!(accessor === null || accessor === void 0 ? void 0 : accessor.isDashboardStoreAccessorInitialized());
    };
    DashboardStoreAccessorRepository.accessors = new Map();
    return DashboardStoreAccessorRepository;
}());
export { DashboardStoreAccessorRepository };
//# sourceMappingURL=DashboardStoreAccessorRepository.js.map